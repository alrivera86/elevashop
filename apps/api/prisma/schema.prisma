// Elevashop - Schema de Base de Datos
// Basado en datos reales del Excel listaprecioJA.xlsx

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USUARIOS Y AUTENTICACIÓN ============

model Usuario {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  passwordHash   String    @map("password_hash")
  nombreCompleto String    @map("nombre_completo")
  rolId          Int       @map("rol_id")
  rol            Rol       @relation(fields: [rolId], references: [id])
  activo         Boolean   @default(true)
  ultimoLogin    DateTime? @map("ultimo_login")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relaciones
  ventas        Venta[]
  transacciones Transaccion[]

  @@map("usuarios")
}

model Rol {
  id          Int       @id @default(autoincrement())
  nombre      String    @unique
  descripcion String?
  permisos    Json      // Array de strings con permisos
  usuarios    Usuario[]

  @@map("roles")
}

// ============ PRODUCTOS E INVENTARIO ============

model Producto {
  id                 Int         @id @default(autoincrement())
  codigo             String      @unique
  nombre             String
  descripcion        String?
  categoriaId        Int?        @map("categoria_id")
  categoria          Categoria?  @relation(fields: [categoriaId], references: [id])

  // Precios (3 niveles como en Excel)
  precioMercadoLibre Decimal     @map("precio_mercado_libre") @db.Decimal(12, 2)
  precioMercado      Decimal     @map("precio_mercado") @db.Decimal(12, 2)
  precioElevapartes  Decimal     @map("precio_elevapartes") @db.Decimal(12, 2)
  precioCosto        Decimal?    @map("precio_costo") @db.Decimal(12, 2)

  // Stock
  stockActual        Int         @default(0) @map("stock_actual")
  stockMinimo        Int         @default(0) @map("stock_minimo")
  stockAdvertencia   Int         @default(0) @map("stock_advertencia")
  estado             EstadoStock @default(OK)

  // Ubicación física
  ubicacion          String?

  // Control
  notificacionEnviada Boolean    @default(false) @map("notificacion_enviada")
  activo             Boolean     @default(true)
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  // Relaciones
  transacciones          Transaccion[]
  movimientosStock       MovimientoStock[]
  alertasStock           AlertaStock[]
  ordenesCompraDetalle   OrdenCompraDetalle[]
  costosImportacion      CostoImportacion[]
  ventasDetalle          VentaDetalle[]
  unidadesInventario     UnidadInventario[]

  @@map("productos")
}

model Categoria {
  id          Int        @id @default(autoincrement())
  nombre      String     @unique
  descripcion String?
  productos   Producto[]

  @@map("categorias")
}

model MovimientoStock {
  id            Int            @id @default(autoincrement())
  productoId    Int            @map("producto_id")
  producto      Producto       @relation(fields: [productoId], references: [id])
  tipo          TipoMovimiento
  cantidad      Int
  stockAnterior Int            @map("stock_anterior")
  stockNuevo    Int            @map("stock_nuevo")
  referencia    String?        // ID de venta, compra, etc.
  motivo        String?
  createdAt     DateTime       @default(now()) @map("created_at")

  @@map("movimientos_stock")
}

model AlertaStock {
  id          Int        @id @default(autoincrement())
  productoId  Int        @map("producto_id")
  producto    Producto   @relation(fields: [productoId], references: [id])
  tipoAlerta  TipoAlerta @map("tipo_alerta")
  stockActual Int        @map("stock_actual")
  stockMinimo Int        @map("stock_minimo")
  mensaje     String?
  resuelta    Boolean    @default(false)
  createdAt   DateTime   @default(now()) @map("created_at")
  resueltaAt  DateTime?  @map("resuelta_at")

  @@map("alertas_stock")
}

// Unidades individuales con serial para trazabilidad
model UnidadInventario {
  id              Int           @id @default(autoincrement())
  productoId      Int           @map("producto_id")
  producto        Producto      @relation(fields: [productoId], references: [id])
  serial          String        @unique

  // Estado de la unidad
  estado          EstadoUnidad  @default(DISPONIBLE)

  // Información de entrada
  fechaEntrada    DateTime      @default(now()) @map("fecha_entrada")
  origenTipo      OrigenUnidad? @map("origen_tipo")
  costoUnitario   Decimal       @map("costo_unitario") @db.Decimal(12, 2)
  lote            String?       // Número de lote o importación

  // Información de venta (cuando aplica)
  fechaVenta      DateTime?     @map("fecha_venta")
  clienteId       Int?          @map("cliente_id")
  cliente         Cliente?      @relation(fields: [clienteId], references: [id])
  precioVenta     Decimal?      @map("precio_venta") @db.Decimal(12, 2)
  metodoPago      MetodoPago?   @map("metodo_pago")
  ventaId         Int?          @map("venta_id")

  // Rentabilidad
  utilidad        Decimal?      @db.Decimal(12, 2) // precioVenta - costoUnitario

  // Garantía
  garantiaMeses   Int           @default(6) @map("garantia_meses")
  garantiaHasta   DateTime?     @map("garantia_hasta")

  // Metadata
  notas           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@index([productoId])
  @@index([estado])
  @@index([clienteId])
  @@map("unidades_inventario")
}

// ============ CLIENTES ============

model Cliente {
  id              Int             @id @default(autoincrement())
  nombre          String
  nombreNormalizado String        @map("nombre_normalizado") // Para búsquedas sin duplicados
  rifCedula       String?         @map("rif_cedula")
  email           String?
  telefono        String?
  direccion       String?
  ciudad          String?
  estado          String?
  segmento        SegmentoCliente @default(NUEVO)
  totalCompras    Decimal         @default(0) @map("total_compras") @db.Decimal(12, 2)
  cantidadOrdenes Int             @default(0) @map("cantidad_ordenes")
  activo          Boolean         @default(true)
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relaciones
  ventas             Venta[]
  transacciones      Transaccion[]
  unidadesCompradas  UnidadInventario[]
  etiquetas          ClienteEtiqueta[]

  @@map("clientes")
}

// ============ ETIQUETAS DE CLIENTES ============

model Etiqueta {
  id          Int               @id @default(autoincrement())
  codigo      String            @unique // CLIENTE_VIP, CLIENTE_GENERAL
  nombre      String            // Cliente VIP, Cliente General
  descripcion String?
  color       String            @default("#6B7280") // Color hex para UI
  activo      Boolean           @default(true)
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relaciones
  clientes    ClienteEtiqueta[]

  @@map("etiquetas")
}

model ClienteEtiqueta {
  id          Int      @id @default(autoincrement())
  clienteId   Int      @map("cliente_id")
  cliente     Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  etiquetaId  Int      @map("etiqueta_id")
  etiqueta    Etiqueta @relation(fields: [etiquetaId], references: [id], onDelete: Cascade)
  asignadoPor String?  @map("asignado_por") // Usuario que asignó la etiqueta
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([clienteId, etiquetaId])
  @@index([clienteId])
  @@index([etiquetaId])
  @@map("cliente_etiquetas")
}

// ============ VENTAS Y TRANSACCIONES ============

model Venta {
  id           Int           @id @default(autoincrement())
  numeroOrden  String?       @unique @map("numero_orden")
  tipoVenta    TipoVenta     @default(VENTA) @map("tipo_venta")
  clienteId    Int           @map("cliente_id")
  cliente      Cliente       @relation(fields: [clienteId], references: [id])
  usuarioId    Int           @map("usuario_id")
  usuario      Usuario       @relation(fields: [usuarioId], references: [id])
  fecha        DateTime      @default(now())
  subtotal     Decimal       @db.Decimal(12, 2)
  descuento    Decimal       @default(0) @db.Decimal(12, 2)
  impuesto     Decimal       @default(0) @db.Decimal(12, 2)
  total        Decimal       @db.Decimal(12, 2)
  estadoPago   EstadoPago    @default(PENDIENTE) @map("estado_pago")
  estado       EstadoVenta   @default(CONFIRMADA)
  notas        String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relaciones
  detalles VentaDetalle[]
  pagos    VentaPago[]

  @@index([tipoVenta])
  @@map("ventas")
}

model VentaDetalle {
  id             Int      @id @default(autoincrement())
  ventaId        Int      @map("venta_id")
  venta          Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  productoId     Int      @map("producto_id")
  producto       Producto @relation(fields: [productoId], references: [id])
  cantidad       Int
  precioUnitario Decimal  @map("precio_unitario") @db.Decimal(12, 2)
  costoUnitario  Decimal? @map("costo_unitario") @db.Decimal(12, 2)
  descuento      Decimal  @default(0) @db.Decimal(12, 2)
  subtotal       Decimal  @db.Decimal(12, 2)
  serial         String?  // Serial del producto vendido

  @@map("ventas_detalle")
}

// Tabla para pagos múltiples por venta (EFECTIVO $ / ZELLE, etc.)
model VentaPago {
  id         Int        @id @default(autoincrement())
  ventaId    Int        @map("venta_id")
  venta      Venta      @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  metodoPago MetodoPago @map("metodo_pago")
  monto      Decimal    @db.Decimal(12, 2)
  moneda     Moneda     @default(USD)
  tasaCambio Decimal?   @map("tasa_cambio") @db.Decimal(10, 4)
  montoBs    Decimal?   @map("monto_bs") @db.Decimal(12, 2)
  referencia String?    // Número de referencia de transferencia
  createdAt  DateTime   @default(now()) @map("created_at")

  @@map("ventas_pagos")
}

// Transacciones individuales (registro histórico del Excel)
model Transaccion {
  id                Int              @id @default(autoincrement())
  tipo              TipoTransaccion
  productoId        Int              @map("producto_id")
  producto          Producto         @relation(fields: [productoId], references: [id])
  clienteId         Int?             @map("cliente_id")
  cliente           Cliente?         @relation(fields: [clienteId], references: [id])
  cantidad          Int
  precioUnitario    Decimal?         @map("precio_unitario") @db.Decimal(12, 2)
  costoUnitario     Decimal?         @map("costo_unitario") @db.Decimal(12, 2)
  total             Decimal?         @db.Decimal(12, 2)
  utilidad          Decimal?         @db.Decimal(12, 2)
  serial            String?
  produccion        String?          // Número de producción
  metodoPago        MetodoPago?      @map("metodo_pago")
  usuarioId         Int              @map("usuario_id")
  usuario           Usuario          @relation(fields: [usuarioId], references: [id])
  fechaEntrada      DateTime?        @map("fecha_entrada")
  fechaSalida       DateTime?        @map("fecha_salida")
  numeroOrden       String?          @map("numero_orden")
  ubicacion         String?
  mes               Int?             // Mes para reportes (1-12)
  anio              Int?             // Año para reportes

  // Desglose de pagos
  montoEfectivoUsd  Decimal?         @map("monto_efectivo_usd") @db.Decimal(12, 2)
  montoBs           Decimal?         @map("monto_bs") @db.Decimal(12, 2)
  montoZelle        Decimal?         @map("monto_zelle") @db.Decimal(12, 2)
  montoBanesco      Decimal?         @map("monto_banesco") @db.Decimal(12, 2)
  tasaCambio        Decimal?         @map("tasa_cambio") @db.Decimal(10, 4)

  createdAt         DateTime         @default(now()) @map("created_at")

  @@map("transacciones")
}

// ============ PROVEEDORES E IMPORTACIONES ============

model Proveedor {
  id            Int       @id @default(autoincrement())
  nombre        String
  razonSocial   String?   @map("razon_social")
  contacto      String?
  email         String?
  telefono      String?
  pais          String?
  activo        Boolean   @default(true)
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relaciones
  ordenesCompra OrdenCompra[]
  importaciones Importacion[]

  @@map("proveedores")
}

model OrdenCompra {
  id            Int               @id @default(autoincrement())
  numeroOrden   String            @unique @map("numero_orden")
  proveedorId   Int               @map("proveedor_id")
  proveedor     Proveedor         @relation(fields: [proveedorId], references: [id])
  fecha         DateTime          @default(now())
  total         Decimal           @db.Decimal(12, 2)
  estado        EstadoOrdenCompra @default(PENDIENTE)
  importacionId Int?              @map("importacion_id")
  importacion   Importacion?      @relation(fields: [importacionId], references: [id])
  createdAt     DateTime          @default(now()) @map("created_at")

  // Relaciones
  detalles OrdenCompraDetalle[]

  @@map("ordenes_compra")
}

model OrdenCompraDetalle {
  id               Int         @id @default(autoincrement())
  ordenCompraId    Int         @map("orden_compra_id")
  ordenCompra      OrdenCompra @relation(fields: [ordenCompraId], references: [id], onDelete: Cascade)
  productoId       Int         @map("producto_id")
  producto         Producto    @relation(fields: [productoId], references: [id])
  cantidadOrdenada Int         @map("cantidad_ordenada")
  cantidadRecibida Int         @default(0) @map("cantidad_recibida")
  precioUnitario   Decimal     @map("precio_unitario") @db.Decimal(12, 2)
  precioDescuento  Decimal?    @map("precio_descuento") @db.Decimal(12, 2)

  @@map("ordenes_compra_detalle")
}

model Importacion {
  id                        Int               @id @default(autoincrement())
  factura                   String            @unique
  proveedorId               Int               @map("proveedor_id")
  proveedor                 Proveedor         @relation(fields: [proveedorId], references: [id])
  montoFactura              Decimal           @map("monto_factura") @db.Decimal(12, 2)
  montoTransferido          Decimal?          @map("monto_transferido") @db.Decimal(12, 2)
  diferencia                Decimal?          @db.Decimal(12, 2)
  numeroTransferencia       String?           @map("numero_transferencia")
  comisionBancoBanesco      Decimal?          @map("comision_banco_banesco") @db.Decimal(10, 2)
  comisionBancoControles    Decimal?          @map("comision_banco_controles") @db.Decimal(10, 2)
  porcentajeNacionalizacion Decimal?          @map("porcentaje_nacionalizacion") @db.Decimal(5, 4)
  seguroNacionalizacion     Decimal?          @map("seguro_nacionalizacion") @db.Decimal(12, 2)
  subTotal                  Decimal?          @map("sub_total") @db.Decimal(12, 2)
  estado                    EstadoImportacion @default(PENDIENTE)
  descripcion               String?
  fechaFactura              DateTime?         @map("fecha_factura")
  fechaLlegada              DateTime?         @map("fecha_llegada")
  createdAt                 DateTime          @default(now()) @map("created_at")
  updatedAt                 DateTime          @updatedAt @map("updated_at")

  // Relaciones
  ordenesCompra     OrdenCompra[]
  costosImportacion CostoImportacion[]

  @@map("importaciones")
}

// Costos de importación por producto
model CostoImportacion {
  id                    Int         @id @default(autoincrement())
  importacionId         Int         @map("importacion_id")
  importacion           Importacion @relation(fields: [importacionId], references: [id])
  productoId            Int         @map("producto_id")
  producto              Producto    @relation(fields: [productoId], references: [id])
  precioUnitarioFOB     Decimal     @map("precio_unitario_fob") @db.Decimal(12, 2)
  descuento             Decimal?    @db.Decimal(12, 2)
  fleteSeguros          Decimal?    @map("flete_seguros") @db.Decimal(12, 2)
  costoCIF              Decimal?    @map("costo_cif") @db.Decimal(12, 2)
  porcentajeNac         Decimal?    @map("porcentaje_nac") @db.Decimal(5, 4)
  ivaUnidad             Decimal?    @map("iva_unidad") @db.Decimal(12, 2)
  comisiones            Decimal?    @db.Decimal(12, 2)
  costoTotal            Decimal?    @map("costo_total") @db.Decimal(12, 2)

  @@map("costos_importacion")
}

// ============ GASTOS Y FINANZAS ============

model Gasto {
  id           Int            @id @default(autoincrement())
  categoriaId  Int            @map("categoria_id")
  categoria    CategoriaGasto @relation(fields: [categoriaId], references: [id])
  monto        Decimal        @db.Decimal(12, 2)
  moneda       Moneda         @default(USD)
  tasaCambio   Decimal?       @map("tasa_cambio") @db.Decimal(10, 4)
  fecha        DateTime
  mes          Int            // 1-12
  anio         Int            // Año
  descripcion  String?
  comprobante  String?
  metodoPago   MetodoPago?    @map("metodo_pago")
  estado       EstadoGasto    @default(PAGADO)
  esRecurrente Boolean        @default(false) @map("es_recurrente")
  createdAt    DateTime       @default(now()) @map("created_at")

  @@map("gastos")
}

model CategoriaGasto {
  id     Int       @id @default(autoincrement())
  nombre String    @unique
  tipo   TipoGasto
  gastos Gasto[]

  @@map("categorias_gasto")
}

model TasaCambio {
  id            Int      @id @default(autoincrement())
  fecha         DateTime @db.Date
  monedaOrigen  Moneda   @map("moneda_origen")
  monedaDestino Moneda   @map("moneda_destino")
  tipo          TipoTasa @default(PARALELO)
  tasa          Decimal  @db.Decimal(10, 4)
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([fecha, monedaOrigen, monedaDestino, tipo])
  @@map("tasas_cambio")
}

// Operaciones de cambio BS/USDT (Binance)
model OperacionCambio {
  id             Int      @id @default(autoincrement())
  cuenta         String   // SR JOSE, ALBERTO, WILMEN
  plataforma     String   @default("BINANCE")
  vendedor       String   // Nombre del vendedor en Binance
  fecha          DateTime
  montoUsd       Decimal  @map("monto_usd") @db.Decimal(12, 2)
  montoBs        Decimal  @map("monto_bs") @db.Decimal(12, 2)
  tasaCambio     Decimal  @map("tasa_cambio") @db.Decimal(10, 4)
  montoElevashop Decimal? @map("monto_elevashop") @db.Decimal(12, 2)
  estado         String   @default("AUN EN BINANCE")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("operaciones_cambio")
}

// ============ ENUMS ============

enum TipoVenta {
  VENTA         // Venta normal
  CONSIGNACION  // Mercancía en consignación
}

enum EstadoStock {
  OK
  ALERTA_W  @map("ALERTA-W")
  ALERTA
  AGOTADO
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
  AJUSTE
  DEVOLUCION
}

enum TipoAlerta {
  STOCK_BAJO
  STOCK_MINIMO
  AGOTADO
  SOBRESTOCK
}

enum EstadoUnidad {
  DISPONIBLE
  RESERVADO
  VENDIDO
  DEFECTUOSO
  DEVUELTO
  CONSIGNADO  // En consignación
}

enum OrigenUnidad {
  COMPRA
  PRODUCCION
  IMPORTACION
  DEVOLUCION
  AJUSTE
}

enum SegmentoCliente {
  VIP
  FRECUENTE
  OCASIONAL
  NUEVO
}

enum TipoTransaccion {
  ENTRADA
  SALIDA
}

enum MetodoPago {
  EFECTIVO_USD
  EFECTIVO_BS
  ZELLE
  BANESCO
  TRANSFERENCIA_BS
  TRANSFERENCIA_USD
  PAGO_MOVIL
  BINANCE
  MIXTO
}

enum EstadoPago {
  PENDIENTE
  PARCIAL
  PAGADO
}

enum EstadoVenta {
  COTIZACION
  PENDIENTE
  CONFIRMADA
  EN_PREPARACION
  ENVIADA
  ENTREGADA
  CANCELADA
}

enum EstadoOrdenCompra {
  PENDIENTE
  CONFIRMADA
  EN_TRANSITO
  RECIBIDA
  CANCELADA
}

enum EstadoImportacion {
  PENDIENTE
  EN_TRANSITO
  EN_ADUANA
  NACIONALIZADA
  RECIBIDA
}

enum EstadoGasto {
  PENDIENTE
  PAGADO
  ANULADO
}

enum TipoGasto {
  NOMINA
  COMISION
  SERVICIO
  IMPUESTO
  OPERATIVO
  MARKETING
  IMPORTACION
  INVERSION
}

enum Moneda {
  USD
  VES
}

enum TipoTasa {
  OFICIAL
  PARALELO
  BCV
  BINANCE
}
